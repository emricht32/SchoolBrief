
{% extends "base.html" %}
{% block content %}
  <div class="card">
    <h2>Family Settings</h2>
    <form method="post">
      <label>Family display name</label>
      <input name="display_name" value="{{ family.display_name or '' }}">

      <label>Recipients (comma-separated emails)</label>
      <input name="recipients" value="{{ pref.to_addresses or '' }}">

      <small class="muted">Includes 2 recipients. $1/month for each additional recipient.</small>

      <label>Children</label>
      <div id="children">
        {% for c in children %}
          <div class="card">
            <label>Name</label><input name="child_name_{{ loop.index0 }}" value="{{ c.name }}">
            <label>Grade</label><input name="child_grade_{{ loop.index0 }}" value="{{ c.grade or '' }}">
            <label>School</label><input name="child_school_{{ loop.index0 }}" value="{{ c.school_name or '' }}">
          </div>
        {% endfor %}
        <div class="card">
          <label>Name</label><input name="child_name_new">
          <label>Grade</label><input name="child_grade_new">
          <label>School</label><input name="child_school_new">
        </div>
      </div>

      <label>School domains (comma-separated)</label>
      <input name="school_domains" value="{{ pref.school_domains or '' }}">


      <label>Keywords (comma-separated)</label>
      <input name="include_keywords" value="{{ pref.include_keywords or '' }}">

      <label>Cadence</label>
      <select name="cadence">
        <option value="daily" {% if pref.cadence=='daily' %}selected{% endif %}>Daily</option>
        <option value="weekly" {% if pref.cadence=='weekly' %}selected{% endif %}>Weekly</option>
      </select>

      <label>Weekly days</label>
      <div style="display:flex;gap:8px;flex-wrap:wrap">
        {% set selected = (pref.days_of_week or '').split(',') %}
        {% for i, label in [(0,'Mon'),(1,'Tue'),(2,'Wed'),(3,'Thu'),(4,'Fri'),(5,'Sat'),(6,'Sun')] %}
          <label style="display:inline-flex;align-items:center;gap:6px;">
            <input type="checkbox" name="dow" value="{{ i }}" {% if (selected and (i|string) in selected) %}checked{% endif %}>
            {{ label }}
          </label>
        {% endfor %}
      </div>
      <input type="hidden" id="days_of_week" name="days_of_week" value="{{ pref.days_of_week or '' }}">
      <script>
        // keep hidden CSV in sync with checkboxes
        document.addEventListener('change', () => {
          const vals = Array.from(document.querySelectorAll('input[name="dow"]:checked')).map(el => el.value);
          document.getElementById('days_of_week').value = vals.join(',');
        });
      </script>


      <label>Send time (local)</label>
      <input name="send_time_local" value="{{ pref.send_time_local or '07:00' }}">

      <label>Timezone</label>
      <input name="timezone" value="{{ pref.timezone or default_tz }}">

      <button class="btn" type="submit">Save</button>
    </form>
  </div>

  <div class="card">
    <h2>Referrals</h2>
    <p>Share this link to get 1 month free when a friend subscribes:</p>
    <code>{{ request.url.scheme }}://{{ request.url.netloc }}/auth/google/start?ref={{ referral_code.code if referral_code else '' }}</code>
  </div>
{% endblock %}
